- [Overview](#overview)
- [Install](#install)
  - [1. Manually Merge into Kernel (Recommended)](#1-manually-merge-into-kernel-recommended)
    - [1. Copy the source files.](#1-copy-the-source-files)
    - [2. Edit Kconfig.](#2-edit-kconfig)
    - [3. Edit Makefile.](#3-edit-makefile)
    - [4. Edit the kernel config](#4-edit-the-kernel-config)
    - [5. Edit the device tree](#5-edit-the-device-tree)
    - [6. Build and deploy the embedded Linux system.](#6-build-and-deploy-the-embedded-linux-system)
  - [2. Use the Quick-Install Bash Script](#2-use-the-quick-install-bash-script)


# Overview

This is a driver for TMDS encoder under Linux DRM structure. Together with Xilinx's pl_disp module it creates a TMDS pipeline on Linux and drives the hardwares built by Zynq's PL resources, including VDMA, timming controller and DVI encoder.

At this moment the driver is only tested on embedded Linux system generated by Petalinux.

# Install

You should first clone this repository and checkout to certain branch corresponding to your linux kernel version, e.g. for kernel version v4.14:

```sh
git clone https://github.com/tsaoo/drm-tmds-pl-drv.git
git checkout v4.14
```

## 1. Manually Merge into Kernel (Recommended)

### 1. Copy the source files.
```sh
# Replace the ${KERNEL} with the absolute location of the linux-xlnx kernel root directory
cp drivers/gpu/drm/xlnx/* ${KERNEL}/drivers/gpu/drm/xlnx/
```

### 2. Edit Kconfig.
```sh
# Edit the Kconfig file in xlnx directory
nano ${KERNEL}/drivers/gpu/drm/xlnx/Kconfig
```
```sh
# Add the following lines:
config DRM_TMDS_PL_DRV
	tristate "DRM TMDS on PL"
	depends on DRM_XLNX
	help
	  DRM driver for TMDS pipeline on PL
```

### 3. Edit Makefile.
```sh
nano ${KERNEL}/drivers/gpu/drm/xlnx/Makefile
```
```makefile
# Append the following line to the end of the makefile:
obj-$(CONFIG_DRM_TMDS_PL_DRV) += drm-tmds-pl-drv.o
```

### 4. Edit the kernel config
```sh
petalinux-config -c kernel
# You can find the 'DRM TMDS on PL' option under:
#   Device Drivers ->
#       Graphics Support ->
#           <*> Xilinx DRM KMS Driver ->
#               <*> DRM TMDS on PL
# Remember to enable the DRM KMS Driver first
```

### 5. Edit the device tree
```sh
# Replace the ${PROJECT} with the absolute location of Petalinux project directory
nano ${PROJECT}/project-spec/meta-user/recipes-bsp/device-tree/files/system-user.dtsi

# Refer to dts_example.dtsi in this repository
```

### 6. Build and deploy the embedded Linux system.

## 2. Use the Quick-Install Bash Script

**Caution: This way of installation may lead to unstable TMDS output for temporarily unknown reasons.**

```sh
# Replace the ${PROJECT} with the absolute path to the Petalinux project directory
source install.sh ${PROJECT}
```